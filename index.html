<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Data Personel PAI 1B</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #064e3b; /* Dark Green Base */
            color: white;
            min-height: 100vh;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- Scrollbar & Glass Effect --- */
        #nameContainer::-webkit-scrollbar { width: 4px; }
        #nameContainer::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); }
        #nameContainer::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.3); border-radius: 4px; }

        .glass-box {
            background: rgba(20, 30, 25, 0.4); 
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
            transform: translateZ(0);
        }

        .glass-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.1s ease, background-color 0.2s ease;
        }
        .glass-item:not(.locked):active { transform: scale(0.98); }
        .glass-item.selected { background: rgba(255, 255, 255, 0.08); border-color: rgba(255, 255, 255, 0.3); }
        .glass-item.locked { opacity: 0.6; background: rgba(0, 0, 0, 0.3); border-color: transparent; cursor: not-allowed; pointer-events: auto; }

        .status-hadir { border-left: 4px solid #10b981; } 
        .status-izin { border-left: 4px solid #facc15; background: rgba(250, 204, 21, 0.1); } 
        .status-sakit { border-left: 4px solid #ef4444; background: rgba(239, 68, 68, 0.1); } 
        .status-alpha { border-left: 4px solid #9ca3af; background: rgba(156, 163, 175, 0.1); } 

        /* --- Background Animation --- */
        .blob { position: fixed; z-index: -1; animation: float 20s infinite alternate; }
        .blob-1 { top: -10%; left: -10%; width: 500px; height: 500px; background: radial-gradient(circle, rgba(5, 150, 105, 0.6) 0%, rgba(5, 150, 105, 0) 70%); }
        .blob-2 { bottom: -10%; right: -10%; width: 400px; height: 400px; background: radial-gradient(circle, rgba(4, 120, 87, 0.6) 0%, rgba(4, 120, 87, 0) 70%); animation-delay: -5s; }
        @keyframes float { 0% { transform: translate3d(0, 0, 0) scale(1); } 100% { transform: translate3d(20px, 40px, 0) scale(1.1); } }

        .custom-input { background: rgba(0, 0, 0, 0.2); border: 1px solid rgba(255, 255, 255, 0.3); color: white; transition: all 0.3s; }
        .custom-input:focus { outline: none; border-color: #34d399; background: rgba(0, 0, 0, 0.4); }

        .static-logo { width: 70px; height: 70px; margin: 0 auto 0.5rem auto; object-fit: contain; display: block; }

        /* --- Modals & Utilities --- */
        #confirmModal, #warningModal { transition: opacity 0.3s ease; }
        #confirmModal.hidden, #warningModal.hidden { pointer-events: none; opacity: 0; }
        #confirmModal:not(.hidden), #warningModal:not(.hidden) { opacity: 1; pointer-events: auto; }
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .pop-in-content { animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        .chevron-icon { transition: transform 0.3s ease; }
        .rotate-180 { transform: rotate(180deg); }
        .dropdown-content { transition: max-height 0.4s ease-out, opacity 0.3s ease-out; max-height: 0; opacity: 0; overflow: hidden; }
        .dropdown-content.open { max-height: 2000px; opacity: 1; }

        /* --- TUTORIAL / TOUR STYLES (ENHANCED) --- */
        
        /* Overlay Gelap untuk fokus */
        #tourOverlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.75);
            z-index: 999;
            opacity: 0; transition: opacity 0.5s ease;
            pointer-events: none;
            touch-action: none; /* Mencegah scroll browser default di area overlay */
        }
        #tourOverlay.active { opacity: 1; pointer-events: auto; }

        /* Element yang sedang disorot */
        .tour-highlight {
            position: relative;
            z-index: 1000 !important;
            box-shadow: 0 0 0 4px #34d399, 0 0 100px 100px rgba(0,0,0,0.5); /* Extended shadow untuk deep focus */
            background-color: #064e3b !important; /* Force solid bg agar teks terbaca jelas */
            border-radius: 12px;
            transition: box-shadow 0.3s ease, transform 0.3s ease; /* Smooth transition */
        }

        /* Tooltip Box Tutorial */
        #tourTooltip {
            position: fixed;
            z-index: 1001;
            width: 280px;
            background: white;
            color: #1f2937;
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transition: top 0.5s cubic-bezier(0.4, 0, 0.2, 1), left 0.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease, transform 0.3s ease;
            opacity: 0;
            transform: translateY(10px) scale(0.95);
            pointer-events: none;
            will-change: top, left; /* Performance optimization */
        }

        #tourTooltip.visible {
            opacity: 1;
            transform: translateY(0) scale(1);
            pointer-events: auto;
        }

        /* Arrow/Tail for tooltip */
        #tourTooltipArrow {
            position: absolute;
            width: 14px;
            height: 14px;
            background: white;
            transform: rotate(45deg);
            transition: left 0.5s ease, top 0.5s ease, bottom 0.5s ease;
        }

        /* Utility Class untuk Lock Scroll pada Body */
        body.tour-active {
            overflow: hidden !important; /* Benar-benar mematikan scrollbar */
            height: 100vh;
        }
        
    </style>
</head>
<body class="p-3">

    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>
    
    <!-- Tutorial Overlay Backdrop -->
    <div id="tourOverlay"></div>

    <main class="w-full max-w-lg glass-box rounded-2xl p-4 relative z-10 flex flex-col gap-3 my-4">
        
        <!-- Header Section -->
        <header id="tour-header" class="text-center border-b border-white/20 pb-2 shrink-0 relative transition-all duration-300 p-2">
            <img src="IAINU.jpg" alt="Logo" class="static-logo" onerror="this.style.display='none'">
            <h1 class="text-lg font-bold tracking-wider text-emerald-300">PRESENSI KEHADIRAN MAHASISWA PAI B</h1>
            <p class="text-[10px] text-emerald-100/70" id="currentDateDisplay"></p>

            <!-- Tombol Bantuan Manual -->
            <button onclick="restartTutorial()" class="absolute top-0 right-0 p-2 text-emerald-200/50 hover:text-emerald-300 transition" title="Bantuan / Tutorial">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" />
                </svg>
            </button>
        </header>

        <!-- Daftar Nama -->
        <section id="tour-names" class="flex flex-col gap-1 shrink-0 p-2 rounded-lg transition-all duration-300">
            <div class="flex items-center justify-between">
                <h2 class="text-xs font-semibold uppercase tracking-widest text-emerald-200">
                    Nama-nama Mahasiswa
                </h2>
                <button onclick="resetAllData()" class="text-[10px] bg-red-500/20 hover:bg-red-500/40 text-red-100 border border-red-500/30 px-3 py-1 rounded transition active:scale-95">
                    Refresh / Reset
                </button>
            </div>
            
            <div class="space-y-1 overflow-y-auto pr-1 custom-scrollbar" id="nameContainer" style="max-height: 280px;">
                <!-- List akan di-render di sini -->
            </div>
        </section>

        <!-- Panel Kontrol -->
        <div class="flex flex-col gap-3">
            
            <!-- Status Panel -->
            <div id="tour-status" class="glass-box p-3 rounded-xl bg-black/10 shrink-0 transition-all duration-300">
                <p class="text-[10px] text-emerald-200 uppercase mb-2 font-bold flex justify-between">
                    <span>Detail Keterangan :</span>
                    <span class="text-[9px] opacity-60 normal-case">Pilih Status</span>
                </p>
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="setStatusForSelected('Alpha')" class="bg-gray-600/40 hover:bg-gray-600 border border-gray-500/50 rounded py-2 text-xs transition active:scale-95 font-medium">Alpha</button>
                    <button onclick="setStatusForSelected('Izin')" class="bg-yellow-600/40 hover:bg-yellow-600 border border-yellow-500/50 rounded py-2 text-xs transition active:scale-95 font-medium">Izin</button>
                    <button onclick="setStatusForSelected('Sakit')" class="bg-red-600/40 hover:bg-red-600 border border-red-500/50 rounded py-2 text-xs transition active:scale-95 font-medium">Sakit</button>
                </div>
            </div>

            <!-- Activity Panel -->
            <div id="tour-activity" class="glass-box p-3 rounded-xl bg-black/10 shrink-0 transition-all duration-300">
                <p class="text-[10px] text-blue-200 uppercase mb-2 font-bold">Mengajukan Tentang :</p>
                <div class="grid grid-cols-3 gap-2 mb-2">
                    <button onclick="setActivityType(this, 'Bertanya')" class="act-btn glass-item rounded py-1.5 text-xs text-center hover:bg-blue-500/30 active:scale-95">Bertanya</button>
                    <button onclick="setActivityType(this, 'Menjawab')" class="act-btn glass-item rounded py-1.5 text-xs text-center hover:bg-blue-500/30 active:scale-95">Menjawab</button>
                    <button onclick="setActivityType(this, 'Menyanggah')" class="act-btn glass-item rounded py-1.5 text-xs text-center hover:bg-blue-500/30 active:scale-95">Menyanggah</button>
                </div>
                
                <div class="flex gap-2 mb-3">
                    <textarea id="activityNote" rows="1" class="custom-input flex-1 rounded-lg p-2 text-xs resize-none" placeholder="Ketik isi aktivitas..."></textarea>
                    <button onclick="addActivityLog()" class="bg-blue-600 hover:bg-blue-500 text-white rounded-lg px-4 flex items-center justify-center shadow-lg transition active:scale-95 border border-blue-400">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                    </button>
                </div>

                <div class="border-t border-white/10 pt-2">
                    <button onclick="toggleActivityDropdown()" class="w-full flex items-center justify-between text-[10px] text-blue-200 uppercase font-bold py-1 hover:bg-white/5 rounded px-2 transition">
                        <span id="activityHeader">Daftar Aktivitas (0)</span>
                        <svg id="activityChevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 chevron-icon">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                        </svg>
                    </button>
                    
                    <div id="activityDropdownContent" class="dropdown-content">
                        <div id="activityListContainer" class="mt-2 space-y-1"></div>
                    </div>
                </div>
            </div>

            <!-- Send Panel -->
            <div id="tour-send" class="space-y-3 mt-2 pb-2 shrink-0 p-2 rounded-xl transition-all duration-300">
                <button onclick="markAllPresent()" class="w-full bg-blue-600/80 hover:bg-blue-500 text-white font-bold py-3 rounded-xl shadow-lg transition active:scale-95 flex items-center justify-center gap-2 border border-blue-400/50">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <span>Hadir Semua</span>
                </button>

                <button onclick="prepareWhatsapp()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-4 rounded-xl shadow-lg transition active:scale-95 flex items-center justify-center gap-2 group border border-emerald-400">
                    <span>Kirim ke WhatsApp</span>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 group-hover:translate-x-1 transition-transform"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.126A59.768 59.768 0 0 1 21.485 12 59.77 59.77 0 0 1 3.27 20.876L5.999 12Zm0 0h7.5" /></svg>
                </button>
            </div>
        </div>

        <!-- Footer Penutup -->
        <footer class="text-center mt-4 pt-4 border-t border-white/10 shrink-0">
            <p class="text-[10px] text-emerald-200/50">
                &copy; 2024 Sistem Presensi PAI 1B.<br/>
                Dibuat dengan Teliti & Aman.
            </p>
        </footer>
    </main>

    <!-- Tutorial Tooltip (Floating) -->
    <div id="tourTooltip">
        <div id="tourTooltipArrow"></div>
        <div class="relative z-10">
            <div class="flex items-center gap-2 mb-2">
                <span class="bg-emerald-100 text-emerald-800 text-[10px] font-bold px-2 py-0.5 rounded-full" id="tourStepBadge">1/4</span>
                <h4 id="tourTitle" class="font-bold text-emerald-700 text-sm">Judul</h4>
            </div>
            <p id="tourDesc" class="text-xs text-slate-600 mb-4 leading-relaxed">Deskripsi</p>
            <div class="flex justify-between items-center border-t border-gray-100 pt-3">
                <button onclick="endTutorial()" class="text-xs text-slate-400 hover:text-red-500 font-medium transition">Lewati</button>
                <button onclick="nextStep()" id="tourNextBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white text-xs px-4 py-2 rounded-lg font-bold shadow-md transition active:scale-95">Lanjut</button>
            </div>
        </div>
    </div>

    <!-- Modal Konfirmasi WA -->
    <div id="confirmModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center hidden p-4">
        <div class="glass-box bg-gray-900/90 rounded-2xl p-6 max-w-sm w-full text-center border border-emerald-500/30 shadow-2xl transform transition-all scale-100">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-emerald-100 mb-4">
                <svg class="h-6 w-6 text-emerald-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
            </div>
            <h3 class="text-lg font-bold text-white mb-2">Konfirmasi</h3>
            <p class="text-sm text-gray-300 mb-6">Data sudah siap. Kirim laporan ke WhatsApp sekarang?</p>
            <div class="flex gap-3 justify-center">
                <button onclick="closeConfirmModal()" class="flex-1 px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded-lg text-sm font-medium transition">Batal</button>
                <button onclick="proceedToWhatsapp()" class="flex-1 px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg text-sm font-bold shadow-lg transition transform active:scale-95">Kirim</button>
            </div>
        </div>
    </div>

    <!-- Modal Peringatan -->
    <div id="warningModal" class="fixed inset-0 bg-black/90 backdrop-blur-md z-[60] flex items-center justify-center hidden p-4">
        <div class="pop-in-content flex flex-col items-center justify-center w-full max-w-sm text-center">
            <div class="w-64 h-64 relative mb-4 rounded-xl overflow-hidden border-2 border-white/10 shadow-[0_0_30px_rgba(255,255,255,0.1)]">
                <video id="warningVideo" class="w-full h-full object-cover mix-blend-screen bg-black" playsinline muted>
                    <source src="placeholder_video.mp4" type="video/mp4">
                    <div class="w-full h-full flex items-center justify-center bg-black text-white">Video Here</div>
                </video>
            </div>
            <p class="text-xl font-bold text-white tracking-wider animate-pulse">Lengkapi Dulu Yaa :)</p>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed top-5 left-1/2 transform -translate-x-1/2 bg-black/80 backdrop-blur border border-emerald-500 text-white px-4 py-2 rounded-full shadow-2xl transition-all duration-300 opacity-0 translate-y-[-20px] pointer-events-none z-50 text-xs">
        <span id="toastMessage">Action Success</span>
    </div>

    <script>
        // --- TUTORIAL VERSION CONFIGURATION ---
        // Ganti angka ini (misal "1.2") jika ada update baru dan ingin tutorial muncul lagi untuk semua orang.
        const TUTORIAL_VERSION = "1.2";

        // --- DATA & VARIABLES ---
        const names = [
            "Ady Surya", "Ahmad Lubadul Fikri", "Alyvia Qurrotal ’Aini", "Anggun Lolyka Hastuti",
            "Aqillah Mazaya", "Arina Manasika", "Devi Kurniasari", "Elok Iis Nurrohmah",
            "Farikhatul Azizah", "Hanan Tsuroya Akyasi", "Hanni Hasanati", "Jembar Juli Yuasti",
            "Lusi Rahmah Oktavia", "Muhammad Hanif Fakhry", "Pniel Munandar", "Putri Dwi Astuti",
            "Riska Ayu Kesuma", "Siti Ulfatur Rohmah", "Tsabita Hasna Hanifah", "Ubaidillah Musthofa",
            "Yoana Dian Riski Astuti", "Youvischa Aulia Arsynta", "Yuyun Lutfiyatul Kh", "Zain Nur Fadilah"
        ];

        let attendanceData = {}; 
        let activityLogs = [];   
        let selectedNames = new Set();
        let currentActivityType = null;
        let pendingWhatsappMessage = "";
        let isDropdownOpen = false;
        let hasExplicitlyMarkedPresent = false;

        const nameContainer = document.getElementById('nameContainer');
        const dateDisplay = document.getElementById('currentDateDisplay');

        // --- INITIALIZATION ---
        const today = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const dateString = today.toLocaleDateString('id-ID', options);
        dateDisplay.innerText = dateString;

        function initAttendance() { names.forEach(name => { attendanceData[name] = 'Hadir'; }); }
        initAttendance();

        function initList() {
            nameContainer.innerHTML = '';
            names.forEach((name, index) => {
                const div = document.createElement('div');
                div.id = `person-${index}`;
                div.className = `glass-item p-3 rounded flex items-center justify-between text-sm select-none status-hadir cursor-pointer hover:bg-white/10`;
                div.onclick = () => toggleSelection(name, index);
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="opacity-50 w-6 text-right">${index + 1}.</span>
                        <span class="font-medium">${name}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="status-text text-[10px] opacity-75 font-bold uppercase tracking-wider text-right"></span>
                        <div class="indicator w-2.5 h-2.5 rounded-full bg-white/10 transition-colors duration-300 shrink-0"></div>
                    </div>
                `;
                nameContainer.appendChild(div);
            });
        }

        function updateListItem(index) {
            const name = names[index];
            const div = document.getElementById(`person-${index}`);
            if (!div) return;
            const status = attendanceData[name];
            const isSelected = selectedNames.has(name);
            const statusTextSpan = div.querySelector('.status-text');
            const indicator = div.querySelector('.indicator');

            let baseClass = "glass-item p-3 rounded flex items-center justify-between text-sm select-none";
            
            if (status === 'Hadir') {
                div.className = `${baseClass} cursor-pointer status-hadir hover:bg-white/10`;
                if(isSelected) div.classList.add('selected');
                statusTextSpan.innerText = '';
                statusTextSpan.classList.remove('text-yellow-300', 'text-red-300', 'text-gray-300');
                div.onclick = () => toggleSelection(name, index);
            } else {
                div.className = `${baseClass} locked`; 
                if(isSelected) div.classList.add('selected');
                div.onclick = (e) => { e.stopPropagation(); showToast("Data sudah dikunci. Klik Refresh untuk ulang."); };
                
                if (status === 'Izin') { div.classList.add('status-izin'); statusTextSpan.innerText = 'IZIN'; statusTextSpan.classList.add('text-yellow-300'); }
                else if (status === 'Sakit') { div.classList.add('status-sakit'); statusTextSpan.innerText = 'SAKIT'; statusTextSpan.classList.add('text-red-300'); }
                else if (status === 'Alpha') { div.classList.add('status-alpha'); statusTextSpan.innerText = 'ALPHA'; statusTextSpan.classList.add('text-gray-300'); }
            }
            indicator.className = `indicator w-2.5 h-2.5 rounded-full ${isSelected ? 'bg-emerald-400 shadow-[0_0_8px_#34d399]' : 'bg-white/10'}`;
        }

        function refreshAllList() { names.forEach((_, index) => updateListItem(index)); }

        function toggleSelection(name, index) {
            if (attendanceData[name] !== 'Hadir') { showToast("Nama ini sudah diisi (Terkunci)"); return; }
            if (selectedNames.has(name)) selectedNames.delete(name);
            else selectedNames.add(name);
            updateListItem(index); 
        }

        function resetAllData() {
            initAttendance(); activityLogs = []; selectedNames.clear(); hasExplicitlyMarkedPresent = false;
            document.getElementById('activityNote').value = '';
            if(isDropdownOpen) toggleActivityDropdown();
            nameContainer.innerHTML = ''; initList(); refreshAllList(); renderActivityPreview();
            showToast("Semua data di-reset");
        }

        function markAllPresent() {
            names.forEach(name => { attendanceData[name] = 'Hadir'; });
            selectedNames.clear(); hasExplicitlyMarkedPresent = true; 
            nameContainer.innerHTML = ''; initList(); refreshAllList();
            showToast("Semua ditandai Hadir");
        }

        function setStatusForSelected(status) {
            if (selectedNames.size === 0) { showToast("⚠️ Pilih nama dulu!"); return; }
            const indicesToUpdate = [];
            selectedNames.forEach(name => {
                attendanceData[name] = status;
                const idx = names.indexOf(name);
                if(idx !== -1) indicesToUpdate.push(idx);
            });
            selectedNames.clear();
            indicesToUpdate.forEach(idx => updateListItem(idx));
            showToast(`✅ Status disimpan: ${status}`);
        }

        function setActivityType(btn, type) {
            document.querySelectorAll('.act-btn').forEach(b => {
                b.classList.remove('bg-blue-500', 'text-white', 'font-bold');
                b.classList.add('glass-item');
            });
            btn.classList.remove('glass-item');
            btn.classList.add('bg-blue-500', 'text-white', 'font-bold');
            currentActivityType = type;
        }

        function addActivityLog() {
            const note = document.getElementById('activityNote').value;
            if (selectedNames.size === 0) { showToast("⚠️ Pilih nama mahasiswa dulu!"); return; }
            const selectedArray = Array.from(selectedNames);
            const invalidPerson = selectedArray.find(name => attendanceData[name] !== 'Hadir');
            if (invalidPerson) { showToast(`⚠️ Error: ${invalidPerson} sedang ${attendanceData[invalidPerson]}!`); return; }
            if (!currentActivityType) { showToast("⚠️ Pilih jenis aktivitas!"); return; }
            if (!note.trim()) { showToast("⚠️ Isi catatan aktivitas!"); return; }

            const indicesToUpdate = [];
            selectedNames.forEach(name => {
                activityLogs.push({ name: name, type: currentActivityType, note: note });
                const idx = names.indexOf(name);
                if(idx !== -1) indicesToUpdate.push(idx);
            });
            document.getElementById('activityNote').value = '';
            selectedNames.clear();
            indicesToUpdate.forEach(idx => updateListItem(idx));
            renderActivityPreview();
            if (!isDropdownOpen) toggleActivityDropdown();
            showToast("✅ Aktivitas ditambahkan");
        }

        function toggleActivityDropdown() {
            isDropdownOpen = !isDropdownOpen;
            const content = document.getElementById('activityDropdownContent');
            const chevron = document.getElementById('activityChevron');
            if (isDropdownOpen) { content.classList.add('open'); chevron.classList.add('rotate-180'); } 
            else { content.classList.remove('open'); chevron.classList.remove('rotate-180'); }
        }

        function renderActivityPreview() {
            const container = document.getElementById('activityListContainer');
            const header = document.getElementById('activityHeader');
            container.innerHTML = '';
            header.innerText = `Daftar Aktivitas (${activityLogs.length})`;
            if (activityLogs.length > 0) {
                activityLogs.forEach((log, idx) => {
                    const div = document.createElement('div');
                    div.className = 'text-[10px] bg-white/5 p-2 rounded flex justify-between items-start border border-white/10';
                    div.innerHTML = `
                        <div>
                            <span class="font-bold text-blue-200">${log.name}</span>
                            <span class="opacity-70 mx-1">=</span>
                            <span class="text-emerald-200">${log.type}</span>
                            <span class="italic opacity-70">"${log.note}"</span>
                        </div>
                        <button onclick="removeLog(${idx})" class="text-red-400 hover:text-red-300 font-bold px-1">x</button>
                    `;
                    container.appendChild(div);
                });
            } else { container.innerHTML = '<div class="text-[10px] text-center opacity-50 italic py-2">Belum ada aktivitas</div>'; }
        }

        function removeLog(index) { activityLogs.splice(index, 1); renderActivityPreview(); }

        window.addEventListener('popstate', function(event) {
            const modal = document.getElementById('confirmModal');
            if (!modal.classList.contains('hidden')) { modal.classList.add('hidden'); }
        });

        function prepareWhatsapp() {
            const isAllHadir = names.every(name => attendanceData[name] === 'Hadir');
            const noActivities = activityLogs.length === 0;
            if (isAllHadir && noActivities && !hasExplicitlyMarkedPresent) {
                const warningModal = document.getElementById('warningModal');
                const warningVideo = document.getElementById('warningVideo');
                warningModal.classList.remove('hidden');
                if (warningVideo) { warningVideo.currentTime = 0; warningVideo.play().catch(e => console.log("Auto-play prevented")); }
                setTimeout(() => { warningModal.classList.add('hidden'); if (warningVideo) warningVideo.pause(); }, 5500);
                return; 
            }
            const presentList = names.filter(name => attendanceData[name] === 'Hadir');
            const absentList = names.filter(name => attendanceData[name] !== 'Hadir');
            let message = `*Daftar Kehadiran Mahasiswa PAI 1B*\n*Tanggal : ${dateString}*\n`; 
            if (presentList.length > 0) { presentList.forEach((name, index) => { message += `${index + 1}. ${name.toUpperCase()}\n`; }); } 
            else { message += `(Tidak ada yang hadir)\n`; }
            message += `\n*Daftar Tidak Hadir Mahasiswa PAI 1B*\n`;
            if (absentList.length === 0) { message += `• NIHIL\n`; } 
            else { absentList.forEach(name => { let status = attendanceData[name]; if (status === 'Alpha') status = 'Tanpa Keterangan'; message += `• ${name} (${status})\n`; }); }
            message += `\n*Daftar Nama Mahasiswa Aktif Kegiatan Perkuliahan (Bertanya, Menjawab, & Menyanggah)*\n`;
            if (activityLogs.length === 0) { message += `• Tidak ada.`; } 
            else { activityLogs.forEach(log => { message += `• ${log.name} : ${log.type} "${log.note}"\n`; }); }
            pendingWhatsappMessage = message;
            document.getElementById('confirmModal').classList.remove('hidden');
            history.pushState({ modalOpen: true }, "", "#confirm");
        }

        function closeConfirmModal() { history.back(); }
        function proceedToWhatsapp() {
            const encodedMessage = encodeURIComponent(pendingWhatsappMessage);
            window.open(`https://wa.me/?text=${encodedMessage}`, '_blank');
            resetAllData(); history.back();
        }
        function showToast(msg) {
            const toast = document.getElementById('toast'); document.getElementById('toastMessage').innerText = msg;
            toast.classList.remove('opacity-0', 'translate-y-[-20px]');
            setTimeout(() => { toast.classList.add('opacity-0', 'translate-y-[-20px]'); }, 2500);
        }

        // ==========================================
        //         TUTORIAL SYSTEM ENGINE (IMPROVED)
        // ==========================================
        
        const tourSteps = [
            { id: 'tour-header', title: 'Selamat Datang!', desc: 'Ini adalah aplikasi presensi kelas PAI 1B. Tanggal akan otomatis terisi.' },
            { id: 'tour-names', title: 'Pilih Nama', desc: 'Klik nama mahasiswa untuk memilihnya. Secara default, status mereka adalah Hadir (Hijau).' },
            { id: 'tour-status', title: 'Ubah Status', desc: 'Jika ada yang tidak hadir, pilih namanya lalu klik tombol status (Izin/Sakit/Alpha) di sini.' },
            { id: 'tour-activity', title: 'Catat Aktivitas', desc: 'Catat keaktifan mahasiswa (bertanya/menjawab) dengan memilih nama, jenis, dan mengisi catatan.' },
            { id: 'tour-send', title: 'Kirim Laporan', desc: 'Jika selesai, tekan tombol ini untuk mengirim laporan rapi langsung ke WhatsApp.' }
        ];
        
        let currentStepIdx = 0;
        let isTransitioning = false;

        // --- Scroll Locking Mechanism (The "Paten" Logic) ---
        function preventDefault(e) { e.preventDefault(); }
        function preventDefaultForScrollKeys(e) {
            // Keys: left: 37, up: 38, right: 39, down: 40, spacebar: 32, pageup: 33, pagedown: 34, end: 35, home: 36
            const keys = {37: 1, 38: 1, 39: 1, 40: 1, 32: 1, 33: 1, 34: 1, 35: 1, 36: 1};
            if (keys[e.keyCode]) { preventDefault(e); return false; }
        }

        // Fungsi untuk mengunci scroll manual user (Touch/MouseWheel/Keyboard)
        function lockScroll() {
            // Modern Chrome requires { passive: false } to preventDefault on touchmove/wheel
            const supportsPassive = false;
            try {
                window.addEventListener("test", null, Object.defineProperty({}, 'passive', {
                    get: function () { supportsPassive = true; } 
                }));
            } catch(e) {}
            const wheelOpt = supportsPassive ? { passive: false } : false;
            
            window.addEventListener('DOMMouseScroll', preventDefault, false); // older FF
            window.addEventListener('wheel', preventDefault, wheelOpt); // modern desktop
            window.addEventListener('touchmove', preventDefault, wheelOpt); // mobile
            window.addEventListener('keydown', preventDefaultForScrollKeys, false);
            
            // Tambahkan class ke body untuk jaga-jaga (hide scrollbar visual)
            document.body.classList.add('tour-active');
        }

        function unlockScroll() {
            window.removeEventListener('DOMMouseScroll', preventDefault, false);
            window.removeEventListener('wheel', preventDefault);
            window.removeEventListener('touchmove', preventDefault);
            window.removeEventListener('keydown', preventDefaultForScrollKeys, false);
            
            document.body.classList.remove('tour-active');
        }

        function checkTutorial() {
            const storedVer = localStorage.getItem('presensi_pai_tutorial_ver');
            if (storedVer !== TUTORIAL_VERSION) {
                setTimeout(startTutorial, 1500); 
            }
        }

        function restartTutorial() {
            startTutorial();
        }

        function startTutorial() {
            currentStepIdx = 0;
            // Lock User Interaction
            lockScroll();
            document.getElementById('tourOverlay').classList.add('active');
            showStep();
        }

        function endTutorial() {
            document.getElementById('tourOverlay').classList.remove('active');
            document.getElementById('tourTooltip').classList.remove('visible');
            
            const prevHigh = document.querySelector('.tour-highlight');
            if (prevHigh) prevHigh.classList.remove('tour-highlight');
            
            // Unlock User Interaction
            unlockScroll();
            localStorage.setItem('presensi_pai_tutorial_ver', TUTORIAL_VERSION);
        }

        function nextStep() {
            if (isTransitioning) return; // Mencegah double click glitch
            isTransitioning = true;
            
            currentStepIdx++;
            if (currentStepIdx >= tourSteps.length) {
                endTutorial();
                isTransitioning = false;
            } else {
                showStep();
                setTimeout(() => { isTransitioning = false; }, 600); // Cooldown untuk animasi scroll
            }
        }

        function showStep() {
            const step = tourSteps[currentStepIdx];
            const targetEl = document.getElementById(step.id);
            const tooltip = document.getElementById('tourTooltip');
            const arrow = document.getElementById('tourTooltipArrow');
            
            // 1. Pindahkan Highlight
            const prevHigh = document.querySelector('.tour-highlight');
            if (prevHigh) prevHigh.classList.remove('tour-highlight');
            
            if (targetEl) {
                targetEl.classList.add('tour-highlight');
                
                // --- SCROLLING MAGIC (PATEN TAPI SMOOTH) ---
                // Kita gunakan setTimeout 0 agar browser render class highlight dulu
                setTimeout(() => {
                    targetEl.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'center',
                        inline: 'center' 
                    });
                }, 50);
            }

            // 2. Update Konten Tooltip
            document.getElementById('tourTitle').innerText = step.title;
            document.getElementById('tourDesc').innerText = step.desc;
            document.getElementById('tourStepBadge').innerText = `${currentStepIdx + 1}/${tourSteps.length}`;
            document.getElementById('tourNextBtn').innerText = (currentStepIdx === tourSteps.length - 1) ? 'Selesai' : 'Lanjut';

            // 3. Kalkulasi Posisi Pintar (Smart Positioning)
            // Timeout sedikit agar scroll selesai sebagian, mencegah glitch posisi tooltip
            setTimeout(() => {
                if (targetEl) {
                    const rect = targetEl.getBoundingClientRect();
                    const tooltipW = 280; 
                    const tooltipH = 180; 
                    const arrowSize = 8; 

                    // Cek ruang di bawah
                    const spaceBelow = window.innerHeight - rect.bottom;
                    
                    let topPos, leftPos, isTop;

                    if (spaceBelow > tooltipH) {
                        topPos = rect.bottom + 20; // Tambah gap sedikit
                        isTop = false;
                    } else {
                        topPos = rect.top - tooltipH - 20;
                        isTop = true;
                    }

                    // Center Horizontal
                    const targetCenter = rect.left + (rect.width / 2);
                    leftPos = targetCenter - (tooltipW / 2);

                    // Clamp Screen Edge
                    if (leftPos < 15) leftPos = 15;
                    if (leftPos + tooltipW > window.innerWidth) leftPos = window.innerWidth - tooltipW - 15;

                    // Apply Position
                    tooltip.style.top = `${topPos}px`;
                    tooltip.style.left = `${leftPos}px`;

                    // Arrow Position
                    let arrowLeft = targetCenter - leftPos - arrowSize;
                    if (arrowLeft < 15) arrowLeft = 15;
                    if (arrowLeft > tooltipW - 30) arrowLeft = tooltipW - 30;

                    arrow.style.left = `${arrowLeft}px`;
                    
                    if (isTop) {
                        arrow.style.bottom = "-7px";
                        arrow.style.top = "auto";
                    } else {
                        arrow.style.top = "-7px";
                        arrow.style.bottom = "auto";
                    }

                    tooltip.classList.add('visible');
                }
            }, 300); // Delay menyesuaikan durasi awal scroll smooth
        }

        // --- INIT ---
        initList(); 
        refreshAllList(); 
        renderActivityPreview(); 
        checkTutorial();

    </script>
</body>
</html>
