import React, { useState, useEffect, useRef } from 'react';
import { 
  Users, 
  CheckCircle, 
  XCircle, 
  AlertCircle, 
  HelpCircle, 
  MessageSquare, 
  Send, 
  Download,
  PlayCircle,
  SkipForward,
  Info
} from 'lucide-react';

// --- KONFIGURASI VERSI APLIKASI ---
// Ganti angka ini jika Anda melakukan update web dan ingin tutorial muncul lagi
const APP_VERSION = '1.0'; 

export default function App() {
  // --- DATA AWAL ---
  const students = [
    "Ady Surya", "Ahmad Lubadul Fikri", "Alyvia Qurrotal ’Aini", "Anggun Lolyka Hastuti",
    "Aqillah Mazaya", "Arina Manasika", "Devi Kurniasari", "Elok Iis Nurrohmah",
    "Farikhatul Azizah", "Hanan Tsuroya Akyasi", "Hanni Hasanati", "Jembar Juli Yuasti",
    "Lusi Rahmah Oktavia", "Muhammad Hanif Fakhry", "Pniel Munandar", "Putri Dwi Astuti",
    "Riska Ayu Kesuma", "Siti Ulfatur Rohmah", "Tsabita Hasna Hanifah", "Ubaidillah Musthofa",
    "Yoana Dian Riski Astuti", "Youvischa Aulia Arsynta", "Yuyun Lutfiyatul Kh", "Zain Nur Fadilah"
  ];

  // --- STATE MANAGEMENT ---
  const [attendance, setAttendance] = useState(() => {
    const initial = {};
    students.forEach(name => initial[name] = 'Hadir');
    return initial;
  });

  const [selectedNames, setSelectedNames] = useState(new Set());
  const [activityLogs, setActivityLogs] = useState([]);
  const [activityType, setActivityType] = useState(''); 
  const [activityNote, setActivityNote] = useState('');
  const [showActivityList, setShowActivityList] = useState(false);
  
  // Tutorial State
  const [showTutorial, setShowTutorial] = useState(false);
  const [tourStep, setTourStep] = useState(0);
  const [tutorialPosition, setTutorialPosition] = useState('bottom'); // 'top' or 'bottom'
  const [modalType, setModalType] = useState(null);

  // Refs
  const namesRef = useRef(null);
  const statusRef = useRef(null);
  const activityRef = useRef(null);
  const sendRef = useRef(null);

  // --- EFFECT: TUTORIAL CHECK WITH VERSIONING ---
  useEffect(() => {
    const storedVersion = localStorage.getItem('presensi_app_version');
    
    // Munculkan tutorial jika belum pernah lihat versi ini
    if (storedVersion !== APP_VERSION) {
      // Delay sedikit agar rendering selesai
      setTimeout(() => setShowTutorial(true), 1000);
    }
  }, []);

  // --- LOGIC HANDLERS ---
  const toggleSelection = (name) => {
    const newSet = new Set(selectedNames);
    if (newSet.has(name)) newSet.delete(name);
    else newSet.add(name);
    setSelectedNames(newSet);
  };

  const setStatus = (status) => {
    if (selectedNames.size === 0) {
      alert("Pilih nama mahasiswa terlebih dahulu!");
      return;
    }
    setAttendance(prev => {
      const next = { ...prev };
      selectedNames.forEach(name => next[name] = status);
      return next;
    });
    setSelectedNames(new Set());
  };

  const addActivity = () => {
    if (selectedNames.size === 0) return alert("Pilih nama mahasiswa!");
    if (!activityType) return alert("Pilih jenis aktivitas!");
    if (!activityNote.trim()) return alert("Isi catatan aktivitas!");

    const newLogs = [];
    selectedNames.forEach(name => {
      if (attendance[name] !== 'Hadir') {
        alert(`${name} statusnya tidak hadir.`);
        return;
      }
      newLogs.push({ name, type: activityType, note: activityNote });
    });

    setActivityLogs([...activityLogs, ...newLogs]);
    setActivityNote('');
    setSelectedNames(new Set());
    setShowActivityList(true);
  };

  const removeActivity = (index) => {
    const newLogs = [...activityLogs];
    newLogs.splice(index, 1);
    setActivityLogs(newLogs);
  };

  const handleReset = () => {
    if(!window.confirm("Reset semua data?")) return;
    const initial = {};
    students.forEach(name => initial[name] = 'Hadir');
    setAttendance(initial);
    setActivityLogs([]);
    setSelectedNames(new Set());
    setActivityNote('');
  };

  const handleSendWA = () => {
    const absent = students.filter(n => attendance[n] !== 'Hadir');
    if (absent.length === 0 && activityLogs.length === 0 && !window.confirm("Semua Hadir & nihil aktivitas? Lanjutkan?")) {
        return;
    }
    setModalType('confirm');
  };

  const processSend = () => {
    const dateStr = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    const present = students.filter(n => attendance[n] === 'Hadir');
    
    let msg = `*PRESENSI KELAS PAI 1B*\n*Tanggal:* ${dateStr}\n\n`;
    msg += `*HADIR (${present.length}):*\n`;
    if(present.length === 0) msg += "- Tidak ada\n";
    else present.forEach((n, i) => msg += `${i+1}. ${n}\n`);
    
    msg += `\n*TIDAK HADIR:*\n`;
    const absent = students.filter(n => attendance[n] !== 'Hadir');
    if(absent.length === 0) msg += "- NIHIL\n";
    else absent.forEach(n => msg += `• ${n} (${attendance[n]})\n`);
    
    msg += `\n*AKTIVITAS KELAS:*\n`;
    if(activityLogs.length === 0) msg += "- Tidak ada catatan keaktifan.\n";
    else activityLogs.forEach(log => msg += `• ${log.name}: ${log.type} "${log.note}"\n`);
    
    const url = `https://wa.me/?text=${encodeURIComponent(msg)}`;
    window.open(url, '_blank');
    setModalType(null);
  };

  // --- TUTORIAL LOGIC ---
  const tourSteps = [
    {
      target: namesRef,
      title: "1. Pilih Mahasiswa",
      desc: "Klik pada nama mahasiswa. Bisa pilih lebih dari satu sekaligus."
    },
    {
      target: statusRef,
      title: "2. Tentukan Status",
      desc: "Setelah nama dipilih, klik tombol di sini (Izin/Sakit/Alpha) jika mereka tidak hadir."
    },
    {
      target: activityRef,
      title: "3. Catat Keaktifan",
      desc: "Pilih mahasiswa, jenis kegiatan, dan isi catatan. Lalu tekan tombol (+) untuk menyimpan."
    },
    {
      target: sendRef,
      title: "4. Kirim Laporan",
      desc: "Tekan tombol ini untuk membuat laporan otomatis ke WhatsApp."
    }
  ];

  const nextStep = () => {
    if (tourStep < tourSteps.length - 1) {
      setTourStep(tourStep + 1);
    } else {
      endTutorial();
    }
  };

  const endTutorial = () => {
    setShowTutorial(false);
    // Simpan versi saat ini ke localStorage agar tidak muncul lagi di versi ini
    localStorage.setItem('presensi_app_version', APP_VERSION);
    setTourStep(0);
  };

  // Logic untuk memindahkan posisi tutorial (Atas/Bawah)
  useEffect(() => {
    if (showTutorial) {
      const currentRef = tourSteps[tourStep].target;
      if (currentRef && currentRef.current) {
        // Scroll element into view
        currentRef.current.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // Cek posisi elemen di layar
        const rect = currentRef.current.getBoundingClientRect();
        const screenHeight = window.innerHeight;
        
        // Jika elemen ada di setengah bawah layar (> 50%), taruh tutorial di ATAS
        // Jika elemen ada di setengah atas layar (< 50%), taruh tutorial di BAWAH
        if (rect.top > screenHeight / 2) {
            setTutorialPosition('top');
        } else {
            setTutorialPosition('bottom');
        }
      }
    }
  }, [tourStep, showTutorial]);

  // --- RENDER HELPERS ---
  const getStatusColor = (status) => {
    switch(status) {
      case 'Hadir': return 'border-l-4 border-emerald-500 hover:bg-emerald-500/10';
      case 'Izin': return 'border-l-4 border-yellow-500 bg-yellow-500/10';
      case 'Sakit': return 'border-l-4 border-rose-500 bg-rose-500/10';
      case 'Alpha': return 'border-l-4 border-slate-500 bg-slate-500/10';
      default: return '';
    }
  };

  return (
    <div className="min-h-screen font-sans bg-[#064e3b] text-white flex flex-col items-center p-4 relative overflow-x-hidden">
      
      {/* Background Blobs */}
      <div className="fixed top-[-10%] left-[-10%] w-[500px] h-[500px] rounded-full bg-emerald-600/30 blur-[100px] pointer-events-none animate-pulse"></div>
      <div className="fixed bottom-[-10%] right-[-10%] w-[400px] h-[400px] rounded-full bg-emerald-800/40 blur-[80px] pointer-events-none animate-pulse delay-1000"></div>

      {/* Main Container */}
      <main className="w-full max-w-lg bg-white/10 backdrop-blur-xl border border-white/20 shadow-2xl rounded-3xl p-5 relative z-10 flex flex-col gap-4 mb-20">
        
        {/* Header */}
        <header className="text-center border-b border-white/10 pb-4 relative">
          <div className="w-16 h-16 bg-white/90 rounded-full mx-auto mb-3 flex items-center justify-center shadow-lg">
             <Users className="w-8 h-8 text-emerald-700" />
          </div>
          <h1 className="text-xl font-bold text-emerald-300 tracking-wide">PRESENSI PAI 1B</h1>
          <p className="text-xs text-emerald-100/70 mt-1">
            {new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
          </p>

          <button 
            onClick={() => setShowTutorial(true)}
            className="absolute top-0 right-0 p-2 text-emerald-200/50 hover:text-emerald-300 transition"
            title="Bantuan / Tutorial"
          >
            <HelpCircle className="w-5 h-5" />
          </button>
        </header>

        {/* 1. Daftar Nama */}
        <section 
            ref={namesRef} 
            className={`flex flex-col gap-2 transition-all duration-500 rounded-xl ${showTutorial && tourStep === 0 ? 'bg-emerald-900/40 ring-2 ring-emerald-400 p-2 shadow-[0_0_30px_rgba(52,211,153,0.3)]' : ''}`}
        >
          <div className="flex justify-between items-end px-1">
            <h2 className="text-xs font-bold text-emerald-200 uppercase tracking-widest">Daftar Mahasiswa</h2>
            <button onClick={handleReset} className="text-[10px] text-rose-300 hover:text-rose-100 bg-rose-500/20 px-2 py-1 rounded border border-rose-500/30">
              Reset Data
            </button>
          </div>

          <div className="max-h-[260px] overflow-y-auto pr-1 space-y-2 scrollbar-thin scrollbar-thumb-white/20 scrollbar-track-transparent">
            {students.map((name, idx) => {
              const status = attendance[name];
              const isSelected = selectedNames.has(name);
              
              return (
                <div 
                  key={idx}
                  onClick={() => toggleSelection(name)}
                  className={`
                    p-3 rounded-lg flex items-center justify-between text-sm cursor-pointer transition-all border border-white/5
                    ${getStatusColor(status)}
                    ${isSelected ? 'bg-white/20 ring-1 ring-white/50 translate-x-1' : 'bg-white/5 hover:bg-white/10'}
                  `}
                >
                  <div className="flex items-center gap-3">
                    <span className="opacity-40 text-xs w-5 text-right font-mono">{idx + 1}.</span>
                    <span className="font-medium">{name}</span>
                  </div>
                  
                  <div className="flex items-center gap-2">
                    {status !== 'Hadir' && (
                      <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded ${
                        status === 'Izin' ? 'text-yellow-300 bg-yellow-900/30' :
                        status === 'Sakit' ? 'text-rose-300 bg-rose-900/30' : 
                        'text-slate-300 bg-slate-700/50'
                      }`}>
                        {status.toUpperCase()}
                      </span>
                    )}
                    <div className={`w-3 h-3 rounded-full transition-all ${isSelected ? 'bg-emerald-400 shadow-[0_0_10px_#34d399]' : 'bg-white/10'}`}></div>
                  </div>
                </div>
              );
            })}
          </div>
        </section>

        {/* 2. Control Panel */}
        <div className="flex flex-col gap-3">
          
          {/* Status Buttons */}
          <div 
            ref={statusRef} 
            className={`bg-black/20 p-3 rounded-xl border border-white/5 transition-all duration-500 ${showTutorial && tourStep === 1 ? 'ring-2 ring-emerald-400 bg-emerald-900/40 shadow-[0_0_30px_rgba(52,211,153,0.3)]' : ''}`}
          >
             <p className="text-[10px] text-emerald-200 uppercase font-bold mb-2">Ubah Status Terpilih :</p>
             <div className="grid grid-cols-3 gap-2">
                {['Alpha', 'Izin', 'Sakit'].map(type => (
                  <button 
                    key={type}
                    onClick={() => setStatus(type)}
                    className={`
                      py-2 text-xs font-medium rounded border transition active:scale-95
                      ${type === 'Alpha' ? 'border-slate-500/50 hover:bg-slate-600/50 text-slate-200' : 
                        type === 'Izin' ? 'border-yellow-500/50 hover:bg-yellow-600/50 text-yellow-200' :
                        'border-rose-500/50 hover:bg-rose-600/50 text-rose-200'}
                      bg-white/5
                    `}
                  >
                    {type}
                  </button>
                ))}
             </div>
          </div>

          {/* Activity Log */}
          <div 
            ref={activityRef} 
            className={`bg-black/20 p-3 rounded-xl border border-white/5 transition-all duration-500 ${showTutorial && tourStep === 2 ? 'ring-2 ring-emerald-400 bg-emerald-900/40 shadow-[0_0_30px_rgba(52,211,153,0.3)]' : ''}`}
          >
            <p className="text-[10px] text-blue-200 uppercase font-bold mb-2">Aktivitas Perkuliahan :</p>
            
            <div className="grid grid-cols-3 gap-2 mb-2">
              {['Bertanya', 'Menjawab', 'Menyanggah'].map(type => (
                <button
                  key={type}
                  onClick={() => setActivityType(type)}
                  className={`py-1.5 text-[11px] rounded transition border ${
                    activityType === type 
                    ? 'bg-blue-600 border-blue-400 text-white shadow-lg' 
                    : 'bg-white/5 border-transparent text-slate-300 hover:bg-white/10'
                  }`}
                >
                  {type}
                </button>
              ))}
            </div>

            <div className="flex gap-2">
              <input 
                type="text" 
                value={activityNote}
                onChange={(e) => setActivityNote(e.target.value)}
                placeholder="Isi topik/catatan..."
                className="flex-1 bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-xs focus:outline-none focus:border-emerald-500 focus:bg-black/40 transition"
              />
              <button 
                onClick={addActivity}
                className="bg-blue-600 hover:bg-blue-500 text-white p-2 rounded-lg transition active:scale-95 shadow-lg border border-blue-400"
              >
                <CheckCircle className="w-5 h-5" />
              </button>
            </div>

            {/* List Toggle */}
            <div className="mt-3 pt-2 border-t border-white/10">
              <button 
                onClick={() => setShowActivityList(!showActivityList)}
                className="w-full flex justify-between items-center text-[10px] text-blue-300 hover:bg-white/5 p-1 rounded transition"
              >
                <span>Daftar Aktivitas ({activityLogs.length})</span>
                <span className={`transform transition ${showActivityList ? 'rotate-180' : ''}`}>▼</span>
              </button>
              
              {showActivityList && (
                 <div className="mt-2 space-y-1">
                    {activityLogs.length === 0 ? (
                      <p className="text-[10px] text-center italic text-white/30 py-2">Belum ada data.</p>
                    ) : (
                      activityLogs.map((log, i) => (
                        <div key={i} className="flex justify-between items-start bg-white/5 p-2 rounded text-[10px]">
                          <div>
                            <span className="font-bold text-blue-200">{log.name}</span>
                            <span className="mx-1 text-white/40">|</span>
                            <span className="text-emerald-300">{log.type}</span>
                            <p className="text-white/60 italic">"{log.note}"</p>
                          </div>
                          <button onClick={() => removeActivity(i)} className="text-rose-400 hover:text-rose-200">
                            <XCircle className="w-3 h-3" />
                          </button>
                        </div>
                      ))
                    )}
                 </div>
              )}
            </div>
          </div>

          {/* Send Button */}
          <button 
            ref={sendRef}
            onClick={handleSendWA}
            className={`
              w-full py-4 rounded-xl font-bold text-white shadow-xl flex items-center justify-center gap-2 border border-emerald-400/50
              bg-gradient-to-r from-emerald-600 to-emerald-500 hover:from-emerald-500 hover:to-emerald-400 
              transition active:scale-95 group
              ${showTutorial && tourStep === 3 ? 'ring-2 ring-white ring-offset-2 ring-offset-emerald-900 animate-pulse' : ''}
            `}
          >
            <Send className="w-5 h-5 group-hover:translate-x-1 transition-transform" />
            <span>Kirim ke WhatsApp</span>
          </button>

        </div>
      </main>

      {/* --- TUTORIAL CARD (NON-BLOCKING) --- */}
      {showTutorial && (
        <div className={`fixed left-0 right-0 z-50 flex justify-center p-4 transition-all duration-500 ${
            tutorialPosition === 'top' ? 'top-0' : 'bottom-0'
        }`}>
          <div className="bg-white/95 backdrop-blur-md text-slate-800 p-5 rounded-2xl shadow-2xl max-w-sm w-full border-t-4 border-emerald-500 animate-[popIn_0.3s_ease-out]">
            <div className="flex items-center justify-between mb-2">
                <span className="bg-emerald-100 text-emerald-700 text-[10px] font-bold px-2 py-0.5 rounded-full">
                  Panduan {tourStep + 1}/{tourSteps.length}
                </span>
                <button onClick={endTutorial} className="text-slate-400 hover:text-rose-500">
                    <XCircle className="w-5 h-5" />
                </button>
            </div>
            
            <h3 className="font-bold text-lg text-emerald-800 mb-1">
              {tourSteps[tourStep].title}
            </h3>
            <p className="text-sm text-slate-600 mb-4 leading-relaxed">
              {tourSteps[tourStep].desc}
            </p>
            
            <div className="flex justify-end gap-3">
                {tourStep > 0 && (
                  <button 
                    onClick={() => setTourStep(tourStep - 1)}
                    className="text-sm text-slate-500 hover:text-slate-700 font-medium px-2"
                  >
                    Kembali
                  </button>
                )}
                <button 
                  onClick={nextStep}
                  className="bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-2 rounded-lg text-sm font-bold shadow-lg transition active:scale-95 flex items-center gap-2"
                >
                  {tourStep === tourSteps.length - 1 ? 'Selesai' : 'Lanjut'}
                  <SkipForward className="w-3 h-3" />
                </button>
            </div>
          </div>
        </div>
      )}

      {/* --- MODAL CONFIRMATION --- */}
      {modalType === 'confirm' && (
        <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
          <div className="bg-slate-900 border border-emerald-500/30 p-6 rounded-2xl w-full max-w-sm text-center shadow-2xl">
            <div className="w-12 h-12 bg-emerald-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
              <MessageSquare className="w-6 h-6 text-emerald-400" />
            </div>
            <h3 className="text-xl font-bold text-white mb-2">Kirim Laporan?</h3>
            <p className="text-sm text-slate-300 mb-6">
              Aplikasi akan membuka WhatsApp dengan format laporan yang sudah tersusun rapi.
            </p>
            <div className="flex gap-3">
              <button 
                onClick={() => setModalType(null)}
                className="flex-1 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-white text-sm font-medium transition"
              >
                Batal
              </button>
              <button 
                onClick={processSend}
                className="flex-1 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white text-sm font-bold shadow-lg transition"
              >
                Buka WA
              </button>
            </div>
          </div>
        </div>
      )}

    </div>
  );
}
